<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Techaer QR generator</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0b1220; --bg2:#0d1426; --card:#0f172a; --ink:#e5edff; --ink-muted:#9db0d3;
    --edge:#1e293b; --brand:#3b82f6; --brand-2:#60a5fa; --btn:#1f2937; --ok:#10b981; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#0f1b35 0%,#0b1220 55%), var(--bg);
       color:var(--ink); font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:22px auto;padding:0 18px}
  .card{background:linear-gradient(180deg,var(--card),#0b1326); border:1px solid var(--edge);
        border-radius:14px; box-shadow:0 18px 60px rgba(0,0,0,.35); padding:22px 24px}
  h1{margin:0 0 18px; font-weight:800; letter-spacing:.2px; display:flex;align-items:center;gap:10px}
  h1::after{content:""; width:10px;height:10px;border-radius:999px;background:#38bdf8; box-shadow:0 0 18px #38bdf8}
  .row{display:flex;flex-wrap:wrap;gap:14px;align-items:center}
  label{color:var(--ink-muted);font-size:14px}
  input,select,button{border-radius:10px;border:1px solid var(--edge); outline:none}
  input,select{padding:10px 12px;background:#0b1426;color:var(--ink)}
  input[type="text"]{min-width:220px;text-transform:uppercase}
  select{min-width:140px;appearance:auto}
  button{padding:10px 14px; background:linear-gradient(180deg,var(--brand),var(--brand-2));
         color:#06101f;border:none; font-weight:700; cursor:pointer; box-shadow:0 6px 24px rgba(59,130,246,.35)}
  button.secondary{background:#111827;color:#e5edff;border:1px solid var(--edge); box-shadow:none}
  button:disabled{opacity:.6; cursor:not-allowed}
  .grid{display:grid; grid-template-columns:1fr 380px; gap:24px; margin-top:20px}
  .box{background:#0b1426; border:1px solid var(--edge); border-radius:12px; padding:12px}
  #qrcanvas{display:block; width:100%; height:auto; background:#fff; border-radius:8px}
  .hint{color:var(--ink-muted); font-size:13px; margin-top:8px}
  .bar{display:flex;gap:10px;align-items:center;margin-top:14px}
  .tag{font-size:13px;padding:4px 8px;border-radius:999px;background:#061021;border:1px solid #0f2346;color:#9db0d3}
  .list{background:#0a1324;border:1px solid var(--edge);border-radius:10px;padding:10px 12px;color:#cbd5e1}
  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
         background:#0b1426;border:1px solid var(--edge);color:#e5edff;border-radius:10px;
         padding:10px 14px; box-shadow:0 10px 30px rgba(0,0,0,.5); display:none}
  .toast.ok{border-color:rgba(16,185,129,.5)}
  .toast.err{border-color:rgba(239,68,68,.6)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Techaer QR generator</h1>

    <div class="row">
      <div>
        <label>Kód (3 znaky)</label><br>
        <input id="code" maxlength="3" placeholder="A7K" autocomplete="off">
      </div>
      <div>
        <label>Typ</label><br>
        <select id="type">
          <option value="START">START</option>
          <option value="END">END</option>
        </select>
      </div>
      <div style="align-self:flex-end; margin-left:auto">
        <button id="gen">Generovat QR</button>
      </div>
      <div style="align-self:flex-end">
        <button id="save" class="secondary" disabled>Stáhnout PNG</button>
      </div>
    </div>

    <div class="grid">
      <div class="box">
        <div class="hint">Dnes vygenerované <b>START</b> kódy:</div>
        <div id="used" class="list" style="margin-top:8px">—</div>
      </div>
      <div class="box">
        <canvas id="qrcanvas" width="512" height="512"></canvas>
        <div class="bar">
          <span class="tag">Černobílý QR • Lvl M</span>
          <span class="tag">Platnost 60&nbsp;s</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- QR knihovna -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script>
/* ========= NASTAV SI BASE URL workeru (bez koncového /) ========= */
const API_BASE = "https://examqr.jendabernard.workers.dev";

/* ====== Pomocné ====== */
const $ = (id) => document.getElementById(id);
const codeEl = $('code'), typeEl = $('type'), genBtn = $('gen'), saveBtn = $('save');
const usedEl = $('used'), qrCanvas = $('qrcanvas'), toastEl = $('toast');

function API(path){ return String(API_BASE).replace(/\/+$/,'') + '/' + String(path).replace(/^\/+/, ''); }
function normalizeCode(s){ return (s||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,3); }
function showToast(msg, kind='ok'){
  toastEl.textContent = msg;
  toastEl.className = 'toast ' + kind;
  toastEl.style.display = 'block';
  setTimeout(()=>toastEl.style.display='none', 2600);
}

/* CORS-safe fetch: žádná custom cache-control hlavička */
async function fetchJSON(url, init = {}){
  const opts = { mode:'cors', cache:'no-store', ...init };
  // Content-Type přidávej jen u POST/PUT, ať se zbytečně nespouští preflight pro GET
  if (opts.method && opts.method !== 'GET' && opts.method !== 'HEAD') {
    opts.headers = { ...(opts.headers||{}), 'Content-Type':'application/json' };
  }
  const res = await fetch(url, opts);
  const text = await res.text();
  let data = null; try { data = text ? JSON.parse(text) : null; } catch { data = { raw:text }; }
  if (!res.ok) throw new Error((data && data.error) || `${res.status} ${res.statusText}`);
  return data;
}

function drawQR(text){
  return new Promise((resolve, reject)=>{
    QRCode.toCanvas(qrCanvas, String(text), {
      width: 512, margin: 2, errorCorrectionLevel: 'M',
      color: { dark: "#000000", light: "#ffffff" }  // klasický černobílý QR
    }, (err)=> err ? reject(err) : resolve());
  });
}

function savePng(){
  const a = document.createElement('a');
  const code = normalizeCode(codeEl.value) || 'CODE';
  const typ  = (typeEl.value || 'QR').toUpperCase();
  a.href = qrCanvas.toDataURL('image/png');
  a.download = `qr_${typ}_${code}.png`;
  document.body.appendChild(a); a.click(); a.remove();
}

/* ====== API akce ====== */

async function refreshUsed(){
  try{
    const data = await fetchJSON(API('api/used') + '?t=' + Date.now()); // cache-buster
    usedEl.textContent = (data.used && data.used.length) ? data.used.join(', ') : '—';
  }catch(e){
    usedEl.textContent = 'Nelze načíst: ' + e.message;
  }
}

async function generate(){
  const code = normalizeCode(codeEl.value);
  const type = (typeEl.value === 'END') ? 'END' : 'START';
  const expSec = 60; // pevně 60 s

  if (code.length !== 3) {
    showToast('Zadej přesně 3 alfanumerické znaky (např. A7K).', 'err');
    return;
  }

  try{
    saveBtn.disabled = true;
    // volání workeru – bez zbytečných hlaviček
    const resp = await fetchJSON(API('api/qr'), {
      method: 'POST',
      body: JSON.stringify({ code, type, expSec })
    });

    // wrapped může přijít jako objekt nebo string
    let wrapped = resp.wrapped;
    if (typeof wrapped === 'string') {
      try { wrapped = JSON.parse(wrapped); }
      catch { wrapped = { payload: wrapped }; }
    }
    if (!wrapped || typeof wrapped.payload !== 'string') {
      throw new Error('Neplatná odpověď API (chybí payload).');
    }

    // QR musí nést přesně JSON.stringify(wrapped)
    await drawQR(JSON.stringify(wrapped));
    saveBtn.disabled = false;

    showToast(`${type} • ${code} • platnost 60 s`, 'ok');
    if (type === 'START') refreshUsed();
  } catch(e){
    // typická chyba z workeru: "Code already used today for START"
    showToast('Chyba: ' + e.message, 'err');
  }
}

/* ====== Dráty ====== */
codeEl.addEventListener('input', () => codeEl.value = normalizeCode(codeEl.value));
genBtn.addEventListener('click', generate);
saveBtn.addEventListener('click', savePng);
['keyup','change'].forEach(ev=>{
  codeEl.addEventListener(ev, e=>{ if(e.key === 'Enter') genBtn.click(); });
});

/* Init */
refreshUsed();
</script>
</body>
</html>
